<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>CNC Fly Food Dispenser</title>
  <meta name="description" content="Manual for CNC Fly Food Dispenser">
  <meta name="generator" content="bookdown 0.4 and GitBook 2.6.7">

  <meta property="og:title" content="CNC Fly Food Dispenser" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="images/system.jpg" />
  <meta property="og:description" content="Manual for CNC Fly Food Dispenser" />
  <meta name="github-repo" content="waylandm/fly-food-robot" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="CNC Fly Food Dispenser" />
  
  <meta name="twitter:description" content="Manual for CNC Fly Food Dispenser" />
  <meta name="twitter:image" content="images/system.jpg" />

<meta name="author" content="Matt Wayland">


<meta name="date" content="2017-07-23">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="raspi.html">
<link rel="next" href="operation.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />










<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Fly Food Robot</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#github"><i class="fa fa-check"></i>Github</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contact"><i class="fa fa-check"></i>Contact</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#colophon"><i class="fa fa-check"></i>Colophon</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="grbl.html"><a href="grbl.html"><i class="fa fa-check"></i><b>2</b> Grbl installation and configuration</a><ul>
<li class="chapter" data-level="2.1" data-path="grbl.html"><a href="grbl.html#overview"><i class="fa fa-check"></i><b>2.1</b> Overview</a></li>
<li class="chapter" data-level="2.2" data-path="grbl.html"><a href="grbl.html#flashing-grbl-to-arduino"><i class="fa fa-check"></i><b>2.2</b> Flashing Grbl to Arduino</a></li>
<li class="chapter" data-level="2.3" data-path="grbl.html"><a href="grbl.html#check-serial-connection-to-grbl"><i class="fa fa-check"></i><b>2.3</b> Check serial connection to Grbl</a></li>
<li class="chapter" data-level="2.4" data-path="grbl.html"><a href="grbl.html#grbl-configuration"><i class="fa fa-check"></i><b>2.4</b> Grbl configuration</a><ul>
<li class="chapter" data-level="2.4.1" data-path="grbl.html"><a href="grbl.html#read-current-configuration"><i class="fa fa-check"></i><b>2.4.1</b> Read current configuration</a></li>
<li class="chapter" data-level="2.4.2" data-path="grbl.html"><a href="grbl.html#check-directionality-of-each-axis."><i class="fa fa-check"></i><b>2.4.2</b> Check directionality of each axis.</a></li>
<li class="chapter" data-level="2.4.3" data-path="grbl.html"><a href="grbl.html#activate-hard-limits"><i class="fa fa-check"></i><b>2.4.3</b> Activate hard limits</a></li>
<li class="chapter" data-level="2.4.4" data-path="grbl.html"><a href="grbl.html#setup-homing"><i class="fa fa-check"></i><b>2.4.4</b> Setup homing</a></li>
<li class="chapter" data-level="2.4.5" data-path="grbl.html"><a href="grbl.html#motor-step-size"><i class="fa fa-check"></i><b>2.4.5</b> Motor step size</a></li>
<li class="chapter" data-level="2.4.6" data-path="grbl.html"><a href="grbl.html#feed-rates-and-acceleration"><i class="fa fa-check"></i><b>2.4.6</b> Feed rates and acceleration</a></li>
<li class="chapter" data-level="2.4.7" data-path="grbl.html"><a href="grbl.html#summary-of-settings"><i class="fa fa-check"></i><b>2.4.7</b> Summary of settings</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="grbl.html"><a href="grbl.html#setting-motor-current"><i class="fa fa-check"></i><b>2.5</b> Setting motor current</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="raspi.html"><a href="raspi.html"><i class="fa fa-check"></i><b>3</b> Raspberry Pi setup</a><ul>
<li class="chapter" data-level="3.1" data-path="raspi.html"><a href="raspi.html#overview-1"><i class="fa fa-check"></i><b>3.1</b> Overview</a></li>
<li class="chapter" data-level="3.2" data-path="raspi.html"><a href="raspi.html#install-image"><i class="fa fa-check"></i><b>3.2</b> Install image</a></li>
<li class="chapter" data-level="3.3" data-path="raspi.html"><a href="raspi.html#network-configuration"><i class="fa fa-check"></i><b>3.3</b> Network configuration</a></li>
<li class="chapter" data-level="3.4" data-path="raspi.html"><a href="raspi.html#install-minicom"><i class="fa fa-check"></i><b>3.4</b> Install minicom</a></li>
<li class="chapter" data-level="3.5" data-path="raspi.html"><a href="raspi.html#expand-filesystem"><i class="fa fa-check"></i><b>3.5</b> Expand filesystem</a></li>
<li class="chapter" data-level="3.6" data-path="raspi.html"><a href="raspi.html#install-python-scripts"><i class="fa fa-check"></i><b>3.6</b> Install python scripts</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="gcode.html"><a href="gcode.html"><i class="fa fa-check"></i><b>4</b> Program robot to fill vials</a><ul>
<li class="chapter" data-level="4.1" data-path="gcode.html"><a href="gcode.html#overview-2"><i class="fa fa-check"></i><b>4.1</b> Overview</a></li>
<li class="chapter" data-level="4.2" data-path="gcode.html"><a href="gcode.html#startSystem"><i class="fa fa-check"></i><b>4.2</b> Start system</a></li>
<li class="chapter" data-level="4.3" data-path="gcode.html"><a href="gcode.html#determine-box-coordinates"><i class="fa fa-check"></i><b>4.3</b> Determine box coordinates</a></li>
<li class="chapter" data-level="4.4" data-path="gcode.html"><a href="gcode.html#calibrate-pump"><i class="fa fa-check"></i><b>4.4</b> Calibrate pump</a></li>
<li class="chapter" data-level="4.5" data-path="gcode.html"><a href="gcode.html#generate-g-code-instructions-for-filling-vials"><i class="fa fa-check"></i><b>4.5</b> Generate G-code instructions for filling vials</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="operation.html"><a href="operation.html"><i class="fa fa-check"></i><b>5</b> Operation</a><ul>
<li class="chapter" data-level="5.1" data-path="operation.html"><a href="operation.html#prepare-system"><i class="fa fa-check"></i><b>5.1</b> Prepare system</a></li>
<li class="chapter" data-level="5.2" data-path="operation.html"><a href="operation.html#fill-boxes"><i class="fa fa-check"></i><b>5.2</b> Fill boxes</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">CNC Fly Food Dispenser</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="gcode" class="section level1">
<h1><span class="header-section-number">4</span> Program robot to fill vials</h1>
<p>Running job without GUI - for testing</p>
<!--
# need 8-9 ml
# pump speed 1800ml/min
# ml/s = 1800/60 = 30
# fill time = 0.3
-->
<pre><code>ssh pi@192.168.1.3

sudo minicom -D /dev/ttyACM0 -b115200

?&lt;Idle|MPos:-5.000,-5.000,-4.993|FS:0,0|Ov:100,100,100&gt;

x-10 y-10 z-10
ok
?&lt;Idle|MPos:-10.000,-10.000,-10.005|FS:0,0&gt;


x-20 y-20 z-30
ok
?&lt;Idle|MPos:-20.000,-20.000,-29.996|FS:0,0&gt;


x-8 y-14 z-62
ok
?&lt;Idle|MPos:-8.000,-14.000,-62.006|FS:0,0&gt;


./robot/py/calibrate_pump.py

./robot/py/stream2.py robot/nc/calibrate_pump.nc /dev/ttyACM0

./robot/py/fill_boxes.py
</code></pre>
<div id="overview-2" class="section level2">
<h2><span class="header-section-number">4.1</span> Overview</h2>
<p>The movement of the robot is programmed in <a href="https://en.wikipedia.org/wiki/G-code">G-code</a>. We only need nine G-code commands to control the robot (table <a href="gcode.html#tab:gCodes">4.1</a>).</p>
<table>
<caption><span id="tab:gCodes">Table 4.1: </span>G-code commands used to control robot.</caption>
<thead>
<tr class="header">
<th align="left">Code</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">x</td>
<td align="left">absolute position of x-axis</td>
</tr>
<tr class="even">
<td align="left">y</td>
<td align="left">absolute position of y-axis</td>
</tr>
<tr class="odd">
<td align="left">z</td>
<td align="left">absolute position of z-axis</td>
</tr>
<tr class="even">
<td align="left">g4</td>
<td align="left">dwell time (control parameter p specifies seconds)</td>
</tr>
<tr class="odd">
<td align="left">m3</td>
<td align="left">set pump rotation to clockwise</td>
</tr>
<tr class="even">
<td align="left">m4</td>
<td align="left">set pump rotation to counter clockwise</td>
</tr>
<tr class="odd">
<td align="left">m8</td>
<td align="left">start pump</td>
</tr>
<tr class="even">
<td align="left">m9</td>
<td align="left">stop pump</td>
</tr>
<tr class="odd">
<td align="left">$h</td>
<td align="left">initiate homing cycle</td>
</tr>
</tbody>
</table>
<p>A G-code program for filling vials of food could be created manually, by listing the necessary commands sequentially in a text file. However, this would be laborious and error prone. If the size of the boxes of vials are known, the G-code can be programmatically generated.</p>
</div>
<div id="startSystem" class="section level2">
<h2><span class="header-section-number">4.2</span> Start system</h2>
<ol style="list-style-type: decimal">
<li>Switch on all devices:</li>
</ol>
<ul>
<li>power supply unit for gShield and motors</li>
<li>raspberry pi</li>
<li>peristaltic pump</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Prime pump</li>
</ol>
<ul>
<li>Position a beaker under the nozzle (figure <a href="gcode.html#fig:primeBeaker">4.1</a>).</li>
<li>Press and hold the prime button on the front of the peristaltic pump until a continuous stream of fly food is pumped into the beaker (figure <a href="gcode.html#fig:primeButton">4.2</a>)</li>
</ul>
<div class="figure" style="text-align: center"><span id="fig:primeBeaker"></span>
<img src="images/prime_beaker.jpg" alt="Positioning of beaker under nozzle to collect fly food expelled during priming of peristaltic pump." width="75%" />
<p class="caption">
Figure 4.1: Positioning of beaker under nozzle to collect fly food expelled during priming of peristaltic pump.
</p>
</div>
<div class="figure" style="text-align: center"><span id="fig:primeButton"></span>
<img src="images/prime_button.jpg" alt="Prime button on peristaltic pump." width="75%" />
<p class="caption">
Figure 4.2: Prime button on peristaltic pump.
</p>
</div>
</div>
<div id="determine-box-coordinates" class="section level2">
<h2><span class="header-section-number">4.3</span> Determine box coordinates</h2>
<div class="figure" style="text-align: center"><span id="fig:loadBoxes2"></span>
<img src="images/one_box_loaded.jpg" alt="Loading boxes of vials." width="50%" /><img src="images/two_boxes_loaded.jpg" alt="Loading boxes of vials." width="50%" />
<p class="caption">
Figure 4.3: Loading boxes of vials.
</p>
</div>
<p>First we need to determine the Cartesian coordinates of the first and last vial in each box.</p>
<ol style="list-style-type: decimal">
<li>Load boxes onto the platform of the robot (figure <a href="gcode.html#fig:loadBoxes2">4.3</a>).</li>
</ol>
<ul>
<li>The first box should be flush with the fence and the guide rail.</li>
<li>The second box should be flush with the first and the guide rail.</li>
<li>The boxes we are using have a pair of double-thickness side-walls and a pair of single-thickness side-walls. The pairs are on opposite sides of the box. With this type of box it is important to note the orientation of the boxes when the Cartesian coordinates of the vials are determined, because the same orientation must be used when filling vials with food. We load the boxes with a double-thickness side-wall facing forwards.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Login to raspberry pi using ssh. My raspberry pi has the IP address 192.168.1.3 and so I would use:</li>
</ol>
<ul>
<li><code>ssh pi@192.168.1.3</code></li>
<li>Default password for the <strong>pi</strong> user account is ‘raspberry’.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li><p>Use minicom to connect to the Grbl controller running on the Arduino:</p>
<pre><code>sudo minicom -D /dev/ttyACM0 -b115200</code></pre></li>
<li><p>Make sure nozzle is at ** home ** position by issuing homing command:</p>
<pre><code>$h</code></pre></li>
<li><p>First we will determine the Cartesian coordinates of the first vial in the first box; this is the vial in the front left corner.</p></li>
</ol>
<ul>
<li><p>Make small movements in X and Y until the nozzle is centred over this vial, <em>e.g.</em>:</p>
<pre><code>x-8 y-8</code></pre></li>
<li><p>Lower the nozzle in small increments until it is just 2-3mm above the the top of the first vial (figure ), <em>e.g.</em>:</p>
<pre><code>z-20</code></pre></li>
<li><p>Query the current X, Y and Z coordinates:</p>
<pre><code>?</code></pre>
<p>Make a note of all three coordinates.</p></li>
</ul>
<div class="figure" style="text-align: center"><span id="fig:box1FirstVial"></span>
<img src="images/box1_first_vial.jpg" alt="Nozzle positioned over the first vial in box 1." width="50%" />
<p class="caption">
Figure 4.4: Nozzle positioned over the first vial in box 1.
</p>
</div>
<div class="figure" style="text-align: center"><span id="fig:box1LastVial"></span>
<img src="images/box1_last_vial.jpg" alt="Nozzle positioned over last vial in box 1." width="50%" />
<p class="caption">
Figure 4.5: Nozzle positioned over last vial in box 1.
</p>
</div>
<div class="figure" style="text-align: center"><span id="fig:box2FirstVial"></span>
<img src="images/box2_first_vial.jpg" alt="Nozzle positioned over the first vial in box 2." width="50%" />
<p class="caption">
Figure 4.6: Nozzle positioned over the first vial in box 2.
</p>
</div>
<div class="figure" style="text-align: center"><span id="fig:box2LastVial"></span>
<img src="images/box2_last_vial.jpg" alt="Nozzle positioned over the last vial in box 2." width="50%" />
<p class="caption">
Figure 4.7: Nozzle positioned over the last vial in box 2.
</p>
</div>
</div>
<div id="calibrate-pump" class="section level2">
<h2><span class="header-section-number">4.4</span> Calibrate pump</h2>
</div>
<div id="generate-g-code-instructions-for-filling-vials" class="section level2">
<h2><span class="header-section-number">4.5</span> Generate G-code instructions for filling vials</h2>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="raspi.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="operation.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/WaylandM/fly-food-robot/edit/master/04-g-code.Rmd",
"text": "Edit"
},
"download": ["fly-food-robot.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
